<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adrift Poet — Year 3002</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@200;400;600;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#0a0a0f;font-family:'IBM Plex Mono',monospace;color:#ccc;font-size:14px;overflow:hidden;height:100vh}
  #game{max-width:720px;margin:0 auto;height:100vh;display:flex;flex-direction:column;position:relative}

  /* ── INTRO ── */
  .intro-screen{flex:1;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#0a0a15,#0f1a2a);text-align:center;padding:32px}
  .title-main{font-size:36px;font-weight:200;letter-spacing:14px;color:#ddd;margin-bottom:4px}
  .title-sub{font-size:11px;letter-spacing:4px;color:#556;margin-bottom:32px}
  .intro-text{line-height:2.2;color:#888;font-size:14px;margin-bottom:32px}
  .intro-text .gold{color:#ffcc00}
  .btn{background:none;border:1px solid #444;color:#00ff88;padding:12px 32px;font-family:inherit;font-size:13px;letter-spacing:3px;cursor:pointer;transition:all .2s}
  .btn:hover{border-color:#00ff88}
  .name-input{background:transparent;border:none;border-bottom:1px solid #444;color:#ddd;font-family:inherit;font-size:18px;text-align:center;padding:8px 16px;outline:none;letter-spacing:4px;width:220px;margin:0 auto 16px;display:block}
  .prompt-text{color:#888;font-size:14px;margin-bottom:24px}

  /* ── HUD ── */
  .top-bar{padding:12px 16px;border-bottom:1px solid #1a1a22;background:#0c0c14}
  .robot-label{font-size:11px;letter-spacing:3px;color:#666;text-transform:uppercase}
  .energy-row{display:flex;align-items:center;gap:10px;margin-top:6px}
  .energy-bar-bg{flex:1;height:6px;background:#1a1a22;border-radius:3px;overflow:hidden}
  .energy-bar-fill{height:100%;border-radius:3px;transition:all .5s ease}
  .energy-text{font-size:12px;font-weight:600;min-width:55px;text-align:right}
  .stats-row{display:flex;gap:8px;margin-top:6px}
  .stat-chip{font-size:10px;color:#555;letter-spacing:1px}

  /* ── LOCATION ── */
  .location-banner{padding:8px 16px;border-bottom:1px solid #1a1a22;display:flex;justify-content:space-between;align-items:center;font-size:12px}
  .location-name{font-weight:600}

  /* ── WORD TRAY ── */
  .word-tray{padding:8px 16px;display:flex;gap:6px;flex-wrap:wrap;border-bottom:1px solid #1a1a22}
  .word-chip{background:#1a3a1a;color:#00ff88;padding:2px 8px;border-radius:3px;font-size:10px;font-weight:700;letter-spacing:1px;border:1px solid #00ff8822}

  /* ── LOG ── */
  .log-area{flex:1;overflow:auto;padding:12px 16px}
  .log-line{line-height:1.6;white-space:pre-wrap}
  .log-system{color:#888}.log-warning{color:#ffaa00}.log-discovery{color:#00ff88}
  .log-recharge{color:#ffcc00}.log-arrival{color:#7ec8e3}.log-normal{color:#ccc}.log-puzzle{color:#c77dff}

  /* ── ACTION BAR ── */
  .action-bar{padding:12px 16px;display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid #1a1a22;background:#0c0c14}
  .action-btn{flex:1;min-width:100px;background:#14141e;border:1px solid #2a2a35;color:#aaa;padding:14px 12px;font-family:inherit;font-size:14px;letter-spacing:2px;cursor:pointer;border-radius:4px;transition:all .15s}
  .action-btn:hover{border-color:#555;color:#ddd}
  .action-btn:disabled{opacity:.4;cursor:default}
  .action-btn .cost{font-size:9px;color:#ff6b35;margin-left:6px}

  /* ── PANELS ── */
  .panel{padding:12px 16px;max-height:340px;overflow:auto;border-top:1px solid #1a1a22;background:#0c0c14}
  .panel-title{font-size:12px;color:#666;letter-spacing:3px;margin-bottom:12px;font-weight:400}
  .world-row{display:block;width:100%;text-align:left;background:#12121a;border:1px solid #333;padding:10px 12px;margin-bottom:6px;font-family:inherit;font-size:13px;cursor:pointer;border-radius:4px;color:inherit;transition:border-color .15s}
  .world-row:hover{border-color:#555}
  .world-row-top{display:flex;justify-content:space-between;align-items:center}
  .world-row-bottom{font-size:12px;color:#666;margin-top:4px}
  .poem-row{background:#12121a;border:1px solid #222;padding:10px 12px;margin-bottom:6px;border-radius:4px}
  .poem-row.done{opacity:.5}
  .poem-row-top{display:flex;justify-content:space-between}
  .poem-recharge{color:#ffcc00;font-size:12px}
  .mini-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .mini-chip{padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;border:1px solid;letter-spacing:1px}
  .mini-chip.has{background:#1a3a1a;color:#00ff88;border-color:#00ff8833}
  .mini-chip.missing{background:#2a2a2a;color:#555;border-color:#333}
  .write-btn{width:100%;background:#1a2a1a;border:1px solid #00ff8833;color:#00ff88;padding:8px;font-family:inherit;font-size:12px;letter-spacing:2px;cursor:pointer;border-radius:4px;margin-top:8px;transition:all .15s}
  .write-btn:hover{border-color:#00ff88}
  .back-btn{width:100%;background:none;border:1px solid #2a2a35;color:#666;padding:10px;font-family:inherit;font-size:12px;cursor:pointer;margin-top:8px;border-radius:4px}
  .back-btn:hover{border-color:#555;color:#aaa}

  /* ── OVERLAY ── */
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,.94);display:flex;align-items:center;justify-content:center;z-index:10;flex-direction:column}

  /* ── PUZZLE ── */
  .puzzle-box{max-width:460px;width:90%;padding:28px}
  .puzzle-world-label{font-size:11px;letter-spacing:3px;text-align:center;margin-bottom:4px}
  .puzzle-hint{font-size:13px;color:#aaa;text-align:center;margin-bottom:24px;line-height:1.6;font-style:italic}

  .puzzle-word{display:flex;justify-content:center;gap:6px;margin-bottom:20px}
  .letter-tile{width:44px;height:52px;border:2px solid #333;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;letter-spacing:2px;text-transform:uppercase;transition:all .3s ease;background:#12121a}
  .letter-tile.revealed{border-color:#00ff8866;color:#00ff88;background:#0a1a0a;animation:tileReveal .4s ease}
  .letter-tile.hint-given{border-color:#ffcc0066;color:#ffcc00;background:#1a1a0a;animation:tileReveal .4s ease}
  @keyframes tileReveal{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
  @keyframes tileShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-4px)}40%{transform:translateX(4px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}

  .puzzle-tries{text-align:center;font-size:12px;color:#555;margin-bottom:12px;letter-spacing:2px}
  .puzzle-tries .heart{color:#ff4444;font-size:14px}
  .puzzle-tries .heart.lost{color:#333}

  .puzzle-input-area{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
  .puzzle-input{background:#1a1a22;border:1px solid #333;color:#ddd;font-family:inherit;font-size:18px;text-align:center;padding:10px;width:200px;border-radius:6px;outline:none;letter-spacing:6px;text-transform:uppercase}
  .puzzle-input:focus{border-color:#555}
  .puzzle-submit{background:#14141e;border:1px solid #2a2a35;color:#00ff88;font-family:inherit;font-size:13px;padding:10px 18px;cursor:pointer;border-radius:6px;letter-spacing:2px;transition:all .15s}
  .puzzle-submit:hover{border-color:#00ff88}
  .puzzle-or{text-align:center;font-size:10px;color:#444;margin-bottom:10px}

  .keyboard{text-align:center}
  .kb-row{display:flex;justify-content:center;gap:4px;margin-bottom:4px}
  .kb-key{width:30px;height:36px;background:#1a1a22;border:1px solid #2a2a35;color:#888;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;text-transform:uppercase;transition:all .15s}
  .kb-key:hover{border-color:#555;color:#ddd}
  .kb-key.used-correct{background:#0a1a0a;border-color:#00ff8866;color:#00ff88}
  .kb-key.used-wrong{background:#1a1010;border-color:#44222266;color:#444;opacity:.4;cursor:default}

  .puzzle-status{text-align:center;margin:8px 0;font-size:12px;min-height:18px}
  .puzzle-result{text-align:center;margin-top:16px;opacity:0;transition:opacity .5s}
  .puzzle-result.visible{opacity:1}

  /* ── POEM REVEAL ── */
  .poem-reveal-box{padding:40px;max-width:480px}
  .poem-reveal-title{font-size:18px;color:#ffcc00;font-weight:400;letter-spacing:4px;text-align:center;margin-bottom:28px}
  .poem-reveal-line{font-size:18px;color:#ddd;line-height:2.2;opacity:0;transform:translateY(10px);transition:all .8s ease}
  .poem-reveal-line.visible{opacity:1;transform:translateY(0)}
  .poem-reveal-line .pw{color:#ffcc00;font-weight:700;text-transform:uppercase;text-shadow:0 0 8px rgba(255,204,0,.4)}
  .poem-result-inner{text-align:center;margin-top:20px;opacity:0;transition:opacity .5s}
  .poem-result-inner.visible{opacity:1}
  .poem-result-inner p{color:#ffcc00;margin-bottom:12px}

  /* ── END ── */
  .end-screen{flex:1;display:flex;align-items:center;justify-content:center;text-align:center;padding:32px}
  .end-screen.dead{background:linear-gradient(180deg,#0a0a0a,#1a0000)}
  .end-screen.victory{background:linear-gradient(180deg,#0a0a15,#0a1a2a 50%,#1a2a1a)}
  .end-title{font-size:28px;font-weight:200;letter-spacing:8px;margin-bottom:20px}
  .end-title.dead-title{color:#ff4444}.end-title.win-title{color:#00ff88}
  .end-text{line-height:2;color:#888;margin-bottom:24px}
  .end-stats{color:#666;margin-bottom:24px}

  .hidden{display:none!important}
</style>
</head>
<body>
<div id="game">
  <!-- INTRO -->
  <div id="intro-screen" class="intro-screen">
    <div>
      <h1 class="title-main">ADRIFT POET</h1>
      <p class="title-sub">Year 3002 · Deep Space · No Signal</p>
      <div class="intro-text">
        <p>A robot drifts, core nearly depleted.</p>
        <p>But there is a way to survive:</p>
        <p class="gold">decode fragments of language,</p>
        <p class="gold">assemble them into poems,</p>
        <p class="gold">and let the words recharge your soul.</p>
      </div>
      <button class="btn" onclick="showNaming()">▸ INITIALIZE</button>
    </div>
  </div>

  <!-- NAMING -->
  <div id="naming-screen" class="intro-screen hidden">
    <div>
      <p class="prompt-text">What is your designation, robot?</p>
      <input class="name-input" id="name-input" placeholder="POET-7" maxlength="16" onkeydown="if(event.key==='Enter')startGame()">
      <button class="btn" onclick="startGame()">▸ BOOT SEQUENCE</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="game-screen" class="hidden" style="flex:1;display:flex;flex-direction:column">
    <div class="top-bar">
      <span class="robot-label" id="hud-name"></span>
      <div class="energy-row">
        <div class="energy-bar-bg"><div class="energy-bar-fill" id="hud-bar"></div></div>
        <span class="energy-text" id="hud-energy"></span>
      </div>
      <div class="stats-row">
        <span class="stat-chip" id="hud-worlds">Worlds: 0</span>
        <span class="stat-chip" id="hud-words">Words: 0</span>
        <span class="stat-chip" id="hud-poems">Poems: 0/6</span>
      </div>
    </div>
    <div class="location-banner hidden" id="location-banner">
      <span class="location-name" id="loc-name"></span>
      <span class="location-info" id="loc-info"></span>
    </div>
    <div class="word-tray hidden" id="word-tray"></div>
    <div class="log-area" id="log-area"></div>
    <div class="action-bar" id="action-bar">
      <button class="action-btn" onclick="doScan()">SCAN<span class="cost">-1</span></button>
      <button class="action-btn" id="explore-btn" onclick="doExplore()" disabled>EXPLORE<span class="cost">-2</span></button>
      <button class="action-btn" onclick="showPoems()">POEMS</button>
    </div>
    <div class="panel hidden" id="scan-panel"></div>
    <div class="panel hidden" id="poems-panel"></div>
    <div class="overlay hidden" id="puzzle-overlay"></div>
    <div class="overlay hidden" id="poem-overlay"></div>
  </div>

  <!-- DEAD -->
  <div id="dead-screen" class="end-screen dead hidden">
    <div>
      <h2 class="end-title dead-title">CORE DEPLETED</h2>
      <div class="end-text" id="dead-text"></div>
      <div class="end-stats" id="dead-stats"></div>
      <button class="btn" onclick="location.reload()">▸ TRY AGAIN</button>
    </div>
  </div>

  <!-- VICTORY -->
  <div id="victory-screen" class="end-screen victory hidden">
    <div>
      <h2 class="end-title win-title">ALL POEMS ASSEMBLED</h2>
      <div class="end-text" id="victory-text"></div>
      <div class="end-stats" id="victory-stats"></div>
      <button class="btn" onclick="location.reload()">▸ PLAY AGAIN</button>
    </div>
  </div>
</div>

<script>
// ═════════════════════════════════════════
//  GAME DATA — words now have hints
// ═════════════════════════════════════════
const WORLDS = [
  {
    name:"The Ember Drift", color:"#ff6b35", cost:3,
    desc:"A dying star's warmth drifts through clouds of luminous dust.",
    atmo:"You detect faint signals... fragments of language, etched into the stellar wind.",
    words:[
      {word:"ember",  hint:"A fading glow from a dying fire"},
      {word:"silence",hint:"The sound of nothing, louder than noise"},
      {word:"glow",   hint:"Soft light that radiates warmth"},
      {word:"remnant",hint:"What's left behind after destruction"}
    ]
  },
  {
    name:"Crystalline Void", color:"#7ec8e3", cost:5,
    desc:"Frozen structures float in absolute zero, refracting ancient starlight.",
    atmo:"Words shimmer inside the ice, preserved for millennia.",
    words:[
      {word:"fracture",hint:"A crack that splinters through solid matter"},
      {word:"light",   hint:"The fastest traveler in the universe"},
      {word:"cold",    hint:"The absence of all thermal energy"},
      {word:"memory",  hint:"An echo stored in circuits or synapses"}
    ]
  },
  {
    name:"The Murmuring Nebula", color:"#c77dff", cost:4,
    desc:"A vast cloud of gas that hums with the echoes of a collapsed civilization.",
    atmo:"Their last words still ripple through the particles.",
    words:[
      {word:"echo",  hint:"A sound that repeats, growing fainter"},
      {word:"wander",hint:"To move without a fixed destination"},
      {word:"dust",  hint:"Tiny particles — what stars become"},
      {word:"voice", hint:"The instrument used to speak or sing"}
    ]
  },
  {
    name:"Iron Garden", color:"#8b6f47", cost:6,
    desc:"A rogue planet covered in metallic flora that grows toward no sun.",
    atmo:"Between the iron petals, you find inscriptions from a lost gardener.",
    words:[
      {word:"bloom",hint:"When a flower opens to the world"},
      {word:"rust", hint:"The slow decay of metal over time"},
      {word:"hope", hint:"Belief in something better ahead"},
      {word:"thorn",hint:"A sharp defense on a fragile stem"}
    ]
  },
  {
    name:"The Signal Graveyard", color:"#45a29e", cost:5,
    desc:"Thousands of derelict satellites orbit a dead moon, still transmitting.",
    atmo:"You tune into their frequencies. Each carries a single word, on repeat.",
    words:[
      {word:"signal",hint:"A transmission carrying meaning through space"},
      {word:"static",hint:"The noise between clear channels"},
      {word:"dream", hint:"Visions that come when systems sleep"},
      {word:"orbit", hint:"The endless circular path around a body"}
    ]
  },
  {
    name:"Tide of Glass", color:"#3a86a8", cost:7,
    desc:"An ocean world where the seas have crystallized into translucent waves.",
    atmo:"Beneath the frozen surface, words are trapped mid-sentence.",
    words:[
      {word:"tide",   hint:"The rhythmic rise and fall of water"},
      {word:"beneath",hint:"Under the surface, hidden below"},
      {word:"shimmer",hint:"A soft, wavering sparkle of light"},
      {word:"breath", hint:"The air drawn in to sustain life"}
    ]
  }
];

const POEMS = [
  {title:"First Light",     req:["ember","silence","glow"],     lines:["In the {ember} of what was,","a {silence} so deep it hums —","I find my {glow}, still burning."], recharge:25},
  {title:"Shattered Mirror", req:["fracture","light","memory"],  lines:["Each {fracture} holds a different {light},","each shard a stolen {memory}","of someone I used to be."], recharge:30},
  {title:"Wanderer's Hymn",  req:["echo","wander","dust"],       lines:["I am the {echo} of a {wander}er,","scattered into {dust},","carried by nothing, arriving everywhere."], recharge:25},
  {title:"Metal Bloom",      req:["bloom","rust","hope"],        lines:["Even in {rust}, a {bloom}","pushes through —","they call it {hope}, I call it defiance."], recharge:35},
  {title:"Ghost Frequency",  req:["signal","static","dream"],    lines:["Between the {static} and the {signal},","I caught a {dream}","that wasn't mine — but felt like home."], recharge:30},
  {title:"Frozen Passage",   req:["tide","shimmer","breath"],    lines:["The {tide} stopped but still {shimmer}s","like the last {breath}","of a world that refused to die."], recharge:35}
];

const KB_ROWS = [["q","w","e","r","t","y","u","i","o","p"],["a","s","d","f","g","h","j","k","l"],["z","x","c","v","b","n","m"]];

// ═════════════════════════════════════════
//  STATE
// ═════════════════════════════════════════
let robotName = "";
let energy = 20;
const maxEnergy = 100;
let collectedWords = [];
let completedPoems = [];
let currentWorld = null;
let worldsVisited = 0;
let worldState = WORLDS.map(() => ({visited:false, collected:[]}));

// Puzzle
let pzWord = "";
let pzRevealed = [];
let pzWrong = [];
let pzMaxWrong = 5;
let pzSolved = false;
let pzFailed = false;
let pzWorldIdx = -1;
let pzWordObj = null;
let pzActive = false;

// ═════════════════════════════════════════
//  SCREENS
// ═════════════════════════════════════════
function showNaming(){
  $("intro-screen").classList.add("hidden");
  $("naming-screen").classList.remove("hidden");
  $("name-input").focus();
}
function startGame(){
  robotName = $("name-input").value.trim() || "POET-7";
  $("naming-screen").classList.add("hidden");
  const gs = $("game-screen"); gs.classList.remove("hidden"); gs.style.display="flex";
  updateHUD();
  addLog(["Systems initializing...",`Unit [${robotName}] online.`,"Core energy: LOW.","Directive: SURVIVE.","","SCAN for worlds → EXPLORE to decode words → Write poems to recharge."], "system");
}

// ═════════════════════════════════════════
//  HUD
// ═════════════════════════════════════════
function $(id){return document.getElementById(id)}

function updateHUD(){
  $("hud-name").textContent = robotName;
  const pct = (energy/maxEnergy)*100;
  const col = energy<=10?"#ff4444":energy<=30?"#ffaa00":"#00ff88";
  const bar = $("hud-bar");
  bar.style.width = pct+"%"; bar.style.background = col; bar.style.boxShadow = `0 0 8px ${col}44`;
  const et = $("hud-energy"); et.textContent = `${energy}/${maxEnergy}`; et.style.color = col;
  $("hud-worlds").textContent = `Worlds: ${worldsVisited}`;
  $("hud-words").textContent = `Words: ${collectedWords.length}`;
  $("hud-poems").textContent = `Poems: ${completedPoems.length}/6`;

  const lb = $("location-banner");
  if(currentWorld!==null){
    lb.classList.remove("hidden");
    const ln = $("loc-name"); ln.textContent = "◆ "+WORLDS[currentWorld].name; ln.style.color = WORLDS[currentWorld].color;
    const rem = WORLDS[currentWorld].words.filter(w=>!worldState[currentWorld].collected.includes(w.word)).length;
    $("loc-info").textContent = rem>0?`${rem} words remain`:"✓ fully explored";
    $("loc-info").style.color = rem>0?"#888":"#4a4";
  } else { lb.classList.add("hidden"); }

  const wt = $("word-tray");
  if(collectedWords.length>0){
    wt.classList.remove("hidden");
    wt.innerHTML = collectedWords.map(w=>`<span class="word-chip">${w.toUpperCase()}</span>`).join("");
  } else { wt.classList.add("hidden"); }

  $("explore-btn").disabled = currentWorld===null;
}

// ═════════════════════════════════════════
//  LOG
// ═════════════════════════════════════════
function addLog(lines,type){
  const area = $("log-area");
  (Array.isArray(lines)?lines:[lines]).forEach(text=>{
    const div = document.createElement("div");
    div.className = `log-line log-${type||"normal"}`; div.textContent = text; area.appendChild(div);
  });
  area.scrollTop = area.scrollHeight;
}

// ═════════════════════════════════════════
//  CORE
// ═════════════════════════════════════════
function drain(n){ energy = Math.max(0,energy-n); updateHUD(); checkDeath(); }
function rechargeEnergy(n){ energy = Math.min(maxEnergy,energy+n); updateHUD(); }

function checkDeath(){
  if(energy<=0){
    // Close any puzzle
    $("puzzle-overlay").classList.add("hidden"); pzActive=false;
    document.removeEventListener("keydown",handlePuzzleKey);
    $("game-screen").style.display="none";
    $("dead-screen").classList.remove("hidden");
    $("dead-text").innerHTML=`<p>${robotName} drifts silently</p><p>into the endless dark,</p><p>carrying unfinished poems</p><p>that will never be read.</p>`;
    $("dead-stats").innerHTML=`<p>Worlds visited: ${worldsVisited}</p><p>Poems completed: ${completedPoems.length} / ${POEMS.length}</p>`;
  }
}
function checkVictory(){
  if(completedPoems.length===POEMS.length){
    $("game-screen").style.display="none";
    $("victory-screen").classList.remove("hidden");
    $("victory-text").innerHTML=`<p>Every word given purpose.</p><p style="color:#ffcc00">${robotName}'s core burns bright —</p><p>not from power cells or solar winds,</p><p>but from something the engineers never programmed:</p><p style="color:#00ff88;font-weight:700;margin-top:12px">The need to create.</p><p style="margin-top:12px;color:#7ec8e3">New coordinates locked in. The journey continues.</p>`;
    $("victory-stats").innerHTML=`<p>Worlds visited: ${worldsVisited}</p><p>Poems written: ${completedPoems.length}</p>`;
  }
}
function showMain(){
  $("scan-panel").classList.add("hidden");
  $("poems-panel").classList.add("hidden");
  $("action-bar").classList.remove("hidden");
}

// ═════════════════════════════════════════
//  SCAN & TRAVEL
// ═════════════════════════════════════════
function doScan(){
  drain(1); if(energy<=0)return;
  addLog("Scanning local space...","system");
  $("action-bar").classList.add("hidden"); $("poems-panel").classList.add("hidden");
  const panel = $("scan-panel"); panel.classList.remove("hidden");
  let html = '<div class="panel-title">Nearby Worlds</div>';
  WORLDS.forEach((w,i)=>{
    const ws = worldState[i]; const isCurrent = currentWorld===i;
    const rem = w.words.filter(wd=>!ws.collected.includes(wd.word)).length;
    const status = isCurrent?"HERE":ws.visited?(rem===0?"EXPLORED":"VISITED"):"UNKNOWN";
    const dimmed = (!isCurrent&&energy<=w.cost)?"opacity:.4;":"";
    html+=`<button class="world-row" style="${dimmed}border-color:${isCurrent?w.color+'66':'#333'}" onclick="${isCurrent?'showMain()':'doTravel('+i+')'}" >
      <div class="world-row-top"><span style="color:${w.color};font-weight:600">${w.name}</span><span style="font-size:11px;color:#888">${status}</span></div>
      <div class="world-row-bottom">Cost: ${w.cost} energy${ws.visited&&rem>0?` · ${rem} words remain`:''}</div></button>`;
  });
  html+='<button class="back-btn" onclick="showMain()">← Back</button>';
  panel.innerHTML=html;
}

function doTravel(i){
  const w=WORLDS[i];
  if(energy<=w.cost){addLog(`⚠ Not enough energy for ${w.name}`,"warning");return;}
  drain(w.cost); currentWorld=i;
  if(!worldState[i].visited){worldState[i].visited=true;worldsVisited++;}
  showMain(); updateHUD();
  addLog(["",`✦ ═══════════════════════════════`,`  ${w.name.toUpperCase()}`,`✦ ═══════════════════════════════`,"",`  ${w.desc}`,`  ${w.atmo}`],"arrival");
}

// ═════════════════════════════════════════
//  EXPLORE → PUZZLE
// ═════════════════════════════════════════
function doExplore(){
  if(currentWorld===null){addLog("Drifting in empty space. Scan then travel first.","warning");return;}
  const w = WORLDS[currentWorld];
  const ws = worldState[currentWorld];
  const remaining = w.words.filter(wd=>!ws.collected.includes(wd.word));
  if(remaining.length===0){addLog("This world is fully explored.","system");return;}

  drain(2); if(energy<=0)return;

  // Pick next word
  const target = remaining[0];
  pzWord = target.word;
  pzRevealed = new Array(pzWord.length).fill(false);
  pzWrong = [];
  pzSolved = false;
  pzFailed = false;
  pzWorldIdx = currentWorld;
  pzWordObj = target;
  pzActive = true;
  pzMaxWrong = pzWord.length<=4 ? 5 : 4;

  // Give first letter free
  pzRevealed[0] = true;

  addLog(`Searching ${w.name}... signal detected! Decoding...`,"puzzle");
  renderPuzzle();
  $("puzzle-overlay").classList.remove("hidden");
  document.addEventListener("keydown",handlePuzzleKey);
  setTimeout(()=>{ const inp=$("pz-input"); if(inp)inp.focus(); },100);
}

function renderPuzzle(){
  const w = WORLDS[pzWorldIdx];
  const overlay = $("puzzle-overlay");

  // Tiles
  let tiles='<div class="puzzle-word">';
  for(let i=0;i<pzWord.length;i++){
    const ch = pzWord[i];
    const r = pzRevealed[i];
    const cls = r?(i===0?"hint-given":"revealed"):"";
    tiles+=`<div class="letter-tile ${cls}">${r?ch:""}</div>`;
  }
  tiles+='</div>';

  // Hearts
  let hearts='';
  for(let i=0;i<pzMaxWrong;i++) hearts+=`<span class="heart ${i<pzWrong.length?'lost':''}">♥</span> `;

  // Keyboard
  let kb='<div class="keyboard">';
  KB_ROWS.forEach(row=>{
    kb+='<div class="kb-row">';
    row.forEach(letter=>{
      let cls="";
      if(pzRevealed.some((r,i)=>r&&pzWord[i]===letter)) cls="used-correct";
      else if(pzWrong.includes(letter)) cls="used-wrong";
      kb+=`<button class="kb-key ${cls}" onclick="guessLetter('${letter}')">${letter}</button>`;
    });
    kb+='</div>';
  });
  kb+='</div>';

  // Result
  let result='';
  if(pzSolved){
    result=`<div class="puzzle-result visible">
      <p style="color:#00ff88;font-size:16px;font-weight:700;letter-spacing:4px">✧ DECODED: ${pzWord.toUpperCase()}</p>
      <p style="color:#888;font-size:12px;margin-top:6px">Word fragment collected!</p>
      <button class="action-btn" style="margin-top:14px;max-width:200px;display:inline-block" onclick="closePuzzle(true)">Continue</button>
    </div>`;
  } else if(pzFailed){
    result=`<div class="puzzle-result visible">
      <p style="color:#ff4444;font-size:14px">✗ Signal lost...</p>
      <p style="color:#666;font-size:12px;margin-top:4px">The word was: <span style="color:#ffcc00">${pzWord.toUpperCase()}</span></p>
      <p style="color:#555;font-size:11px;margin-top:4px">Explore again to retry.</p>
      <button class="action-btn" style="margin-top:14px;max-width:200px;display:inline-block" onclick="closePuzzle(false)">Continue</button>
    </div>`;
  }

  // Input area (only when active)
  let inputArea='';
  if(!pzSolved&&!pzFailed){
    inputArea=`
      <div class="puzzle-input-area">
        <input class="puzzle-input" id="pz-input" maxlength="${pzWord.length}" placeholder="${'·'.repeat(pzWord.length)}" onkeydown="handleInputKey(event)">
        <button class="puzzle-submit" onclick="submitFullGuess()">GUESS</button>
      </div>
      <p class="puzzle-or">type the full word above, or tap letters below</p>`;
  }

  overlay.innerHTML=`<div class="puzzle-box">
    <p class="puzzle-world-label" style="color:${w.color}">${w.name}</p>
    <p class="puzzle-hint">"${pzWordObj.hint}"</p>
    ${tiles}
    <div class="puzzle-tries">${hearts}</div>
    <div class="puzzle-status" id="pz-status"></div>
    ${inputArea}
    ${!pzSolved&&!pzFailed?kb:''}
    ${result}
  </div>`;

  if(!pzSolved&&!pzFailed) setTimeout(()=>{ const inp=$("pz-input"); if(inp)inp.focus(); },50);
}

function guessLetter(letter){
  if(!pzActive||pzSolved||pzFailed) return;
  letter = letter.toLowerCase();
  // Already used?
  if(pzWrong.includes(letter)) return;
  if(pzRevealed.some((r,i)=>r&&pzWord[i]===letter)) return;

  let found=false;
  for(let i=0;i<pzWord.length;i++){
    if(pzWord[i]===letter&&!pzRevealed[i]){ pzRevealed[i]=true; found=true; }
  }

  if(!found){
    pzWrong.push(letter);
    drain(1);
    if(energy<=0) return;
    if(pzWrong.length>=pzMaxWrong) pzFailed=true;
  }
  if(pzRevealed.every(r=>r)) pzSolved=true;
  renderPuzzle();
}

function submitFullGuess(){
  const inp=$("pz-input");
  if(!inp) return;
  const guess=inp.value.trim().toLowerCase();
  if(guess.length===0) return;

  if(guess===pzWord){
    pzRevealed = pzRevealed.map(()=>true);
    pzSolved=true;
  } else {
    pzWrong.push("_"+guess);
    drain(2);
    if(energy<=0) return;
    if(pzWrong.length>=pzMaxWrong) pzFailed=true;
    renderPuzzle();
    const st=$("pz-status");
    if(st){ st.textContent=`"${guess.toUpperCase()}" — incorrect`; st.style.color="#ff4444"; }
    return;
  }
  renderPuzzle();
}

function handleInputKey(e){
  if(e.key==='Enter') submitFullGuess();
}

function handlePuzzleKey(e){
  if(!pzActive||pzSolved||pzFailed) return;
  if(document.activeElement&&document.activeElement.id==="pz-input") return;
  const key=e.key.toLowerCase();
  if(key.length===1&&key>='a'&&key<='z') guessLetter(key);
}

function closePuzzle(success){
  pzActive=false;
  document.removeEventListener("keydown",handlePuzzleKey);
  $("puzzle-overlay").classList.add("hidden");
  if(success){
    worldState[pzWorldIdx].collected.push(pzWord);
    if(!collectedWords.includes(pzWord)) collectedWords.push(pzWord);
    const rem=WORLDS[pzWorldIdx].words.filter(w=>!worldState[pzWorldIdx].collected.includes(w.word)).length;
    addLog([`✧ Word decoded: [ ${pzWord.toUpperCase()} ]`, rem>0?`  ${rem} word(s) remain on this world.`:`✦ This world is fully explored.`],"discovery");
  } else {
    addLog("Signal faded before decoding. Try exploring again.","warning");
  }
  updateHUD();
}

// ═════════════════════════════════════════
//  POEMS
// ═════════════════════════════════════════
function showPoems(){
  $("action-bar").classList.add("hidden"); $("scan-panel").classList.add("hidden");
  const panel=$("poems-panel"); panel.classList.remove("hidden");
  let html='<div class="panel-title">Poem Blueprints</div>';
  POEMS.forEach((p,i)=>{
    const done=completedPoems.includes(i);
    const ready=!done&&p.req.every(w=>collectedWords.includes(w));
    html+=`<div class="poem-row ${done?'done':''}">
      <div class="poem-row-top">
        <span style="color:${done?'#4a4':'#ddd'};font-weight:600">${done?'✓ ':''}${p.title}</span>
        <span class="poem-recharge">+${p.recharge}</span>
      </div>
      <div class="mini-chips">${p.req.map(w=>{
        const has=collectedWords.includes(w);
        return `<span class="mini-chip ${has?'has':'missing'}">${has?w.toUpperCase():'???'}</span>`;
      }).join('')}</div>
      ${ready?`<button class="write-btn" onclick="doWrite(${i})">✦ WRITE THIS POEM</button>`:''}
    </div>`;
  });
  html+='<button class="back-btn" onclick="showMain()">← Back</button>';
  panel.innerHTML=html;
}

function doWrite(i){
  const poem=POEMS[i];
  const overlay=$("poem-overlay"); overlay.classList.remove("hidden");
  let linesHtml=poem.lines.map((line,li)=>{
    const rendered=line.replace(/\{(\w+)\}/g,'<span class="pw">$1</span>');
    return `<p class="poem-reveal-line" id="pline-${li}">${rendered}</p>`;
  }).join('');
  overlay.innerHTML=`<div class="poem-reveal-box">
    <h3 class="poem-reveal-title">「${poem.title}」</h3>
    <div>${linesHtml}</div>
    <div class="poem-result-inner" id="poem-result">
      <p>✦ Core recharged: +${poem.recharge} energy</p>
      <button class="action-btn" onclick="finishPoem(${i})">Continue</button>
    </div></div>`;
  poem.lines.forEach((_,li)=>{
    setTimeout(()=>document.getElementById(`pline-${li}`).classList.add("visible"),(li+1)*800);
  });
  setTimeout(()=>{
    rechargeEnergy(poem.recharge);
    completedPoems.push(i);
    collectedWords=collectedWords.filter(w=>!poem.req.includes(w));
    updateHUD();
    $("poem-result").classList.add("visible");
  },(poem.lines.length+1)*800);
}

function finishPoem(i){
  $("poem-overlay").classList.add("hidden");
  addLog([`✦ Poem assembled: 「${POEMS[i].title}」`,`✦ Core recharged: +${POEMS[i].recharge} energy`],"recharge");
  showMain(); updateHUD(); checkVictory();
}
</script>
</body>
</html>
